name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Google GenAI Library
        run: pip install google-genai

      - name: Create and Run Audit Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat << 'EOF' > audit.py
          import os
          import sys
          from google import genai
          
          API_KEY = os.environ.get("GEMINI_API_KEY")
          if not API_KEY:
              print("‚ùå Error: GEMINI_API_KEY is missing!")
              sys.exit(1)

          client = genai.Client(api_key=API_KEY)
          
          # --- MODEL SELECTOR ---
          # In 2026, we try Gemini 2.0 first.
          target_models = ["gemini-2.0-flash-exp", "gemini-2.0-flash", "gemini-1.5-flash-latest"]
          
          # 1. READ CODE
          code_text = ""
          extensions = {'.ts', '.js', '.py', '.json', '.html', '.css'}
          
          print("üìÇ Reading files...")
          for root, dirs, files in os.walk("./src"):
              for file in files:
                  if os.path.splitext(file)[1] in extensions:
                      path = os.path.join(root, file)
                      try:
                          with open(path, "r", encoding="utf-8") as f:
                              code_text += f"\n--- FILE: {path} ---\n{f.read()}\n"
                      except:
                          pass

          if len(code_text) < 10:
              print("‚ö†Ô∏è No code found to review.")
              sys.exit(0)

          # 2. CALL API
          print(f"üöÄ Sending {len(code_text)} characters to Gemini...")
          
          prompt = f"""
          You are a Senior Code Reviewer. Review this Diff/Codebase.
          Focus on: 1. Critical Bugs, 2. Security Vulnerabilities.
          
          CODEBASE:
          {code_text[:900000]}
          """

          # Try models in order until one works
          for model_name in target_models:
              print(f"üîÑ Trying model: {model_name}...")
              try:
                  response = client.models.generate_content(
                      model=model_name, 
                      contents=prompt
                  )
                  print("\n" + "="*30)
                  print(f"‚úÖ SUCCESS ({model_name})")
                  print("="*30)
                  print(response.text)
                  sys.exit(0) # Exit successfully
              except Exception as e:
                  print(f"‚ö†Ô∏è Failed with {model_name}: {e}")

          # If we get here, all models failed. Let's list what IS available.
          print("\n‚ùå All attempts failed. Listing available models to debug:")
          try:
              # This might vary slightly by SDK version, but usually works
              import google.generativeai as old_genai
              old_genai.configure(api_key=API_KEY)
              for m in old_genai.list_models():
                  print(f" - {m.name}")
          except:
              print("Could not list models.")
              
          sys.exit(1)
          EOF
          
          python audit.py
